@model IEnumerable<RolixSAEProject.Models.Produit>
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer V

@section Styles {
    <link rel="stylesheet" href="~/css/products.css" asp-append-version="true" />
}

@{
    ViewData["Title"] = V["Products_PageTitle"];
    var currency = ViewBag.CurrentCurrency as string ?? "EUR";
    var symbol = currency switch
    {
        "CHF" => "CHF",
        "USD" => "$",
        _ => "€"
    };
}

<div class="products-shell">

    <div class="products-topline">
        <div>
            <h1 class="products-title">@V["Products_Title"]</h1>
        </div>
    </div>

    <div class="products-divider"></div>

    <form id="filtersForm" method="get" asp-controller="Produits" asp-action="Index" class="filters-card filters-card--new">
        <input type="hidden" name="page" value="0" />

        <!-- SEARCH centered -->
        <div class="filters-searchline">
            <div class="search-field">
                <span class="search-icon" aria-hidden="true">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M10.5 18.5a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" stroke="currentColor" stroke-width="2" />
                        <path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                </span>

                <input type="text"
                       id="search"
                       name="search"
                       value="@ViewBag.CurrentSearch"
                       placeholder="@V["Products_SearchPlaceholder"]"
                       autocomplete="off" />
            </div>
        </div>

        <!-- FILTERS + PRICE (same line) -->
        <div class="filters-oneline">

            <div class="field">
                <label for="collection">@V["Products_LabelCollection"]</label>
                <select id="collection" name="collection">
                    <option value="all">@V["Products_OptionAll_Fem"]</option>
                    @if (ViewBag.Collections != null)
                    {
                        foreach (string col in (IEnumerable<string>)ViewBag.Collections)
                        {
                            bool isSelected = (string?)ViewBag.CurrentCollection == col;
                            <option value="@col" selected="@(isSelected ? "selected" : null)">@col</option>
                        }
                    }
                </select>
            </div>

            <div class="field">
                <label for="categorie">@V["Products_LabelType"]</label>
                <select id="categorie" name="categorie">
                    <option value="all">@V["Products_OptionAll_Fem"]</option>
                    @if (ViewBag.Categories != null)
                    {
                        foreach (string cat in (IEnumerable<string>)ViewBag.Categories)
                        {
                            bool isSelected = (string?)ViewBag.CurrentCategorie == cat;
                            <option value="@cat" selected="@(isSelected ? "selected" : null)">@cat</option>
                        }
                    }
                </select>
            </div>

            <div class="field">
                <label for="genre">@V["Products_LabelGender"]</label>
                <select id="genre" name="genre">
                    <option value="all">@V["Products_OptionAll_Masc"]</option>
                    @if (ViewBag.Genres != null)
                    {
                        foreach (string g in (IEnumerable<string>)ViewBag.Genres)
                        {
                            bool isSelected = (string?)ViewBag.CurrentGenre == g;
                            <option value="@g" selected="@(isSelected ? "selected" : null)">@g</option>
                        }
                    }
                </select>
            </div>

            <!-- PRICE: same line -->
            <div class="field field-price">
                <label>@V["Products_LabelPrice"]</label>
                <div class="price-seg" role="group" aria-label="@V["Products_AriaPriceSorting"]">
                    <button type="submit"
                            name="sort"
                            value="price_asc"
                            class="price-seg-btn @(ViewBag.CurrentSort == "price_asc" ? "is-active" : "")">
                        @V["Products_PriceAsc"]
                    </button>

                    <button type="submit"
                            name="sort"
                            value="price_desc"
                            class="price-seg-btn @(ViewBag.CurrentSort == "price_desc" ? "is-active" : "")">
                        @V["Products_PriceDesc"]
                    </button>
                </div>
            </div>

            <div class="filters-count">
                @(Model?.Count() ?? 0) @V["Products_CountLabel"]
            </div>

        </div>

        <div class="filters-divider"></div>
    </form>

    @if (Model != null && Model.Any())
    {
        <div class="products-grid">
            @foreach (var p in Model)
            {
                var imageUrl = string.IsNullOrWhiteSpace(p.ImageUrl)
                ? Url.Content("~/images/placeholder-watch.svg")
                : p.ImageUrl;

                <article class="product-card">
                    <div class="product-media">
                        <a asp-controller="Produits" asp-action="Details" asp-route-id="@p.Id">
                            <img src="@imageUrl" alt="@p.Nom" />
                        </a>
                    </div>

                    <div class="product-body">
                        <div class="product-name">@p.Nom</div>

                        @* Remplace "Reference" si ton champ a un autre nom *@
                        <div class="product-ref">@p.Reference</div>

                        <div class="product-price">
                            @p.GetPrice(currency).ToString("N0") @symbol
                        </div>

                        <div class="product-actions">
                            <a class="product-btn"
                               asp-controller="Produits"
                               asp-action="Details"
                               asp-route-id="@p.Id">
                                @V["Products_ViewDetails"]
                            </a>
                        </div>
                    </div>
                </article>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            @V["Products_Empty"]
        </div>
    }

</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
          const form = document.getElementById("filtersForm");
          if (!form) return;

          const selects = form.querySelectorAll("select");
          selects.forEach(s => s.addEventListener("change", () => form.submit()));

          const search = form.querySelector("#search");
          let t = null;
          if (search) {
            search.addEventListener("input", () => {
              clearTimeout(t);
              t = setTimeout(() => form.submit(), 450);
            });
          }
        });
    </script>
}
