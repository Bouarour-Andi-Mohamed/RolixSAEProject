@model IEnumerable<RolixSAEProject.Models.Produit>
@section Styles {
    <link rel="stylesheet" href="~/css/products.css" asp-append-version="true" />
}

@{
    ViewData["Title"] = "Liste des produits";
    var currency = ViewBag.CurrentCurrency as string ?? "EUR";
    var symbol = currency switch
    {
        "CHF" => "CHF",
        "USD" => "$",
        _ => "€"
    };
}


<div class="products-shell">

    <div class="products-topline">
        <div>
            <h1 class="products-title">Nos montres Rolix</h1>
            <p class="products-subtitle">Catalogue connecté à Dataverse (environnement sandbox).</p>
        </div>
        <div class="products-subtitle">
            Devise active : <strong>@currency</strong>
        </div>
    </div>

    <div class="products-divider"></div>

    <form id="filtersForm" method="get" asp-controller="Produits" asp-action="Index" class="filters-card">
        <div class="filters-row">

            <div class="field">
                <label for="search">Recherche</label>
                <input type="text"
                       id="search"
                       name="search"
                       value="@ViewBag.CurrentSearch"
                       placeholder="Nom de la montre..." />
            </div>

            <div class="field">
                <label for="categorie">Catégorie</label>
                <select id="categorie" name="categorie">
                    <option value="all">Toutes</option>
                    @if (ViewBag.Categories != null)
                    {
                        foreach (string cat in (IEnumerable<string>)ViewBag.Categories)
                        {
                            bool isSelected = (string?)ViewBag.CurrentCategorie == cat;
                            <option value="@cat" selected="@(isSelected ? "selected" : null)">@cat</option>
                        }
                    }
                </select>
            </div>

            <div class="field">
                <label for="collection">Collection</label>
                <select id="collection" name="collection">
                    <option value="all">Toutes</option>
                    @if (ViewBag.Collections != null)
                    {
                        foreach (string col in (IEnumerable<string>)ViewBag.Collections)
                        {
                            bool isSelected = (string?)ViewBag.CurrentCollection == col;
                            <option value="@col" selected="@(isSelected ? "selected" : null)">@col</option>
                        }
                    }
                </select>
            </div>

            <div class="field">
                <label for="genre">Genre</label>
                <select id="genre" name="genre">
                    <option value="all">Tous</option>
                    @if (ViewBag.Genres != null)
                    {
                        foreach (string g in (IEnumerable<string>)ViewBag.Genres)
                        {
                            bool isSelected = (string?)ViewBag.CurrentGenre == g;
                            <option value="@g" selected="@(isSelected ? "selected" : null)">@g</option>
                        }
                    }
                </select>
            </div>

            <div class="field field-price">
                <label>Prix</label>
                <div class="sort-group" role="group" aria-label="Tri prix">
                    <button type="submit"
                            name="sort"
                            value="price_asc"
                            class="button button-outline @(ViewBag.CurrentSort == "price_asc" ? "active" : "")">
                        Prix ↑
                    </button>

                    <button type="submit"
                            name="sort"
                            value="price_desc"
                            class="button button-outline @(ViewBag.CurrentSort == "price_desc" ? "active" : "")">
                        Prix ↓
                    </button>
                </div>
            </div>

        </div>
    </form>

    @if (Model != null && Model.Any())
    {
        <div class="products-grid">
            @foreach (var p in Model)
            {
                var imageUrl = string.IsNullOrWhiteSpace(p.ImageUrl)
                ? Url.Content("~/images/placeholder-watch.svg")
                : p.ImageUrl;

                <article class="product-card">
                    <div class="product-media">
                        <a asp-controller="Produits" asp-action="Details" asp-route-id="@p.Id">
                            <img src="@imageUrl" alt="@p.Nom" />
                        </a>
                    </div>

                    <div class="product-body">
                        <h3 class="product-name">@p.Nom</h3>

                        <p class="product-meta">
                            <strong>Catégorie :</strong> @p.Categorie<br />
                            <strong>Collection :</strong> @p.Collection
                        </p>

                        <div class="product-price">
                            @p.GetPrice(currency).ToString("N0") @symbol
                        </div>

                        <div class="product-actions">
                            <a class="button button-outline"
                               asp-controller="Produits"
                               asp-action="Details"
                               asp-route-id="@p.Id">
                                Voir le détail
                            </a>
                        </div>
                    </div>
                </article>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            Aucune montre n’est disponible pour le moment.
        </div>
    }

</div>
